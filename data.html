<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>IMDb Web Application Metadata Table</title>

        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    </head>
    <body>
        <script>
        let currentOffset = 0;     // start with row 0
        let limit = 20;            // load 20 rows at a time
        let hasMore = true;        // true if there's more data to laod
        let currentSearch = '';    // initally set search blank

        function loadBatch() {
            // if there's no more data
            if (!hasMore){
                document.getElementById('load-button').disabled = true;
                document.getElementById('load-button').textContent = 'No more data';
                return; // exit
            }
            const btn = document.getElementById('load-button');
            btn.style.display = 'none';

            // base url (no searches)
            let url = `/api/data?offset=${currentOffset}&limit=${limit}`;
            
            // search if there's value
            if (currentSearch) {
                url += `&search=${encodeURIComponent(currentSearch)}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(metadata => {
                    const tbody = document.getElementById('dataList');
                    
                    // if no data available
                     if (metadata.length === 0) {
                        hasMore = false;
                        btn.textContent = 'No data available';
                        btn.disabled = true;
                        return;
                    }
                    
                    // populate the table
                    metadata.forEach(data => {
                        const row = document.createElement('tr');

                        // Helper to create a cell
                        const createCell = (text) => {
                        const td = document.createElement('td');
                        td.textContent = text == null ? '' : text;
                        return td;
                        };

                        // append data cells
                        row.appendChild(createCell(data.metadata_key));
                        row.appendChild(createCell(data.tconst));
                        row.appendChild(createCell(data.primary_title));
                        row.appendChild(createCell(data.original_title));
                        row.appendChild(createCell(data.title_type));
                        row.appendChild(createCell(data.is_adult));
                        row.appendChild(createCell(data.runtime_minutes));
                        row.appendChild(createCell(data.year));

                        // edit button cell
                        const editCell = document.createElement('td');
                        const editButton = document.createElement('button');
                        editButton.className = 'icon-button';
                        editButton.onclick = () => {
                        window.location.href = `edit.html?id=${encodeURIComponent(data.metadata_key)}`;
                        };
                        const editIcon = document.createElement('i');
                        editIcon.className = 'fa-regular fa-pen-to-square';
                        editIcon.style.color = 'var(--accent)';
                        editButton.appendChild(editIcon);
                        editCell.appendChild(editButton);
                        row.appendChild(editCell);

                        tbody.appendChild(row);
                    });
                        // add loaded data length to offset, for start of next load
                        currentOffset += metadata.length;

                        // if rows to load < limit
                        if (metadata.length < limit) {
                            hasMore = false;
                            if (btn) {
                                btn.textContent = 'No more data';
                                btn.disabled = true;
                            }
                        }

                        // "load more" button
                        if (btn) {
                            btn.style.display = 'inline-block';
                        }

                        // total rows loaded
                        const paginationContainer = document.querySelector('.pagination-container');
                        if (paginationContainer) {
                            paginationContainer.textContent = `Total rows loaded: ${currentOffset}`;
                        }
            }).catch(error => {
                console.error('Error loading metadata:', error);
                alert('Failed to load more data');
                if (btn) {
                    btn.style.display = 'inline-block';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadBatch(); // Load first batch

            const loadButton = document.getElementById('load-button');
            if (loadButton) {
                loadButton.addEventListener('click', () => {
                    loadBatch();
                });
            } else {
                console.error('Load button #load-button not found');
            }

            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    currentSearch = e.target.value.trim();
                    currentOffset = 0;
                    hasMore = true;
                    document.getElementById('dataList').innerHTML = '';
                    loadBatch();
                });
            } else {
                console.warn('Search input #searchInput not found');
            }
        });

        searchInput.addEventListener('input', (e) => {
            // explicitly set to empty string if blank
            const rawValue = e.target.value || '';
            currentSearch = rawValue.trim(); // "" if empty/whitespace

            currentOffset = 0;
            hasMore = true;
            
            // fixed button
            const btn = document.getElementById('load-button');
            if (btn) {
                btn.textContent = 'Load More';
                btn.disabled = false;
                btn.style.display = 'inline-block';
            }
            document.getElementById('dataList').innerHTML = '';
            loadBatch();
        });
        </script>

        <div id="table-container">
            <div id="table-header">
                <h3>Metadata Table</h3>
                <button class="green-button" onclick="window.location.href='create.html';">Create</button>
                <button class="red-button" onclick="window.location.href='index.html';">Disconnect</button>
            </div>
            <!-- search bar -->
            <div style ="margin-bottom: 20px;">
                <input type="text" class = "input-field" id="searchInput" placeholder="Search titles...">
            </div>
            <table>
                <tr>
                    <th>metadata_key</th>
                    <th>tconst</th>
                    <th>primary_title</th>
                    <th>original_title</th>
                    <th>title_type</th>
                    <th>is_adult</th>
                    <th>runtime_minutes</th>
                    <th>year</th>
                    <th>Edit</th>
                </tr>
                <tbody id="dataList">
                    <!-- data rows will be populated here -->
                </tbody>
            </table>

            <button class="accent-button" id="load-button" style="margin: 30px;">Load More</button>

            <div class="pagination-container">
                <!-- total rows loaded -->
            </div>
        </div>
    </body>
</html>