<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Edit Record</title>

        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    </head>
    </head>
    <body>
        <button class="icon-button" onclick="window.location.href='data.html';"><i class="fa-solid fa-arrow-left" style="color: var(--primary); margin: 30px;"></i></button>
        <div class="form-container">
            <h3>Edit Record</h3>
            <div class="input-container">
                <span class="input-header">primary_title</span>
                <input type="text" class="input-field" id="primary_title" value="primary_title" required>
            </div>
            <div class="input-container">
                <span class="input-header">original_title</span>
                <input type="text" class="input-field" id="original_title" value="Enter original_title" required>
            </div>
            <div class="input-container">
                <span class="input-header">title_type</span>
                <select class="input-field" id="title_type" style="width:545px;" required>
                    <option value="movie">movie</option>
                    <option value="tvSeries">tvSeries</option>
                    <option value="short">short</option>
                    <option value="tvMovie">tvMovie</option>
                    <option value="tvEpisode">tvEpisode</option>
                    <option value="video">video</option>
                    <option value="tvMiniSeries">tvMiniseries</option>
                    <option value="tvSpecial">tvSpecial</option>
                    <option value="tvShort">tvShort</option>
                    <option value="videoGame">videoGame</option>
                </select>
            </div>
            <div class="input-container">
                <span class="input-header">is_adult</span>
                <div class="radio-container">
                    <input type="radio" id="f" name="is_adult" value="f">
                    <label class="radio-header" for="f">f</label>
                </div>
                <div class="radio-container">
                    <input type="radio" id="t" name="is_adult" value="t">
                    <label class="radio-header" for="t">t</label>
                </div>
            </div>
            <div class="input-container">
                <span class="input-header">runtime_minutes</span>
                <input type="number" class="input-field" id="runtime_minutes" value="100" required>
            </div>  
            <div class="input-container">
                <span class="input-header">year</span>
                <input type="number" class="input-field" id="year" value="2025" required>
            </div>
            <button class="accent-button" style="margin: 30px;">Save Changes</button>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                // helper functions because is_adult is radio buttons
                function getIsAdultValue() {
                    return document.querySelector('input[name="is_adult"]:checked')?.value || 'f'; // default to 'f'
                }
                function setIsAdultValue(value) {
                    if (value === 'f' || value === 't') {
                        document.getElementById(value).checked = true;
                    }
                }

                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('id'); 

                let originalYear = null;
                let tconst = null;

                fetch(`/api/edit?id=${encodeURIComponent(id)}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to load record');
                        return response.json();
                    })
                    .then(metadata => {
                        const setVal = (id, value) => {
                            const el = document.getElementById(id);
                            if (el) {
                                el.value = value || '';
                            } else {
                                console.warn(`Element with id="${id}" not found`);
                            }
                        };

                        originalYear = metadata.year;
                        tconst = metadata.tconst; // needed in case that the updated row will move from one slave to another

                        // loading current values
                        setVal('primary_title', metadata.primary_title);
                        setVal('original_title', metadata.original_title);
                        setVal('title_type', metadata.title_type);
                        //setVal('is_adult', metadata.is_adult);
                        setIsAdultValue(metadata.is_adult);
                        setVal('runtime_minutes', metadata.runtime_minutes);
                        setVal('year', metadata.year);
                    })
                    .catch(error => console.error('Error fetching record:', error));

                // saving the changes
                function saveRecord() {
                    const getVal = (id) => {
                        const el = document.getElementById(id);
                        return el ? el.value : '';
                    };

                    const updatedData = {
                        metadata_key: urlParams.get('id'),
                        primary_title: document.getElementById('primary_title').value,
                        original_title: document.getElementById('original_title').value,
                        title_type: document.getElementById('title_type').value,
                        //is_adult: document.getElementById('is_adult').value,
                        is_adult: getIsAdultValue(),
                        runtime_minutes: document.getElementById('runtime_minutes').value,
                        year: document.getElementById('year').value,
                        tconst: tconst,
                        oldYear: originalYear
                    };

                    fetch('/api/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updatedData)
                    })

                    .then(response => response.json())
                    
                    .then(() => {
                        alert('Record updated successfully!');
                        // back to data list
                        window.location.href = 'data.html';
                    })
                    .catch(error => {
                        console.error('Save error:', error);
                        alert('Failed to save: ' + error.message);
                    });
                }

                const btn = document.querySelector('.accent-button');
                if (btn) {
                    btn.addEventListener('click', saveRecord);
                } else {
                    console.error('Save button (.accent-button) not found');
                }
            });
        </script>
    </body>
</html>